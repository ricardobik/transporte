<!DOCTYPE html>
<html>

<head>
    <!--Import Google Icon Font-->
    <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link type="text/css" rel="stylesheet" href="/sass/materialize.css" media="screen,projection" />
    <link type="text/css" rel="stylesheet" href="/sass/table.css" media="screen" />

    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body>

    <style>
        .card-title {
            line-height: 48px;
            font-size: 24px;
            font-weight: 300;
        }

    </style>

    <!-- Import Navbar -->
    <div id="nav-bar"></div>

    <div class="container">
        <div class="row">

            <div id="admin" class="col s10 offset-s1 ">
                <div class="card material-table">
                    <div class="card-content">
                        <div class="table-header">
                            <span class="card-title">Pesquisar Setor</span>
                            <div class="actions">
                                <input id="search-input" type="text" class="search-header">
                                <a href="#" id="search-icon" class="waves-effect btn-flat nopadding"><i class="material-icons">search</i></a>
                            </div>
                        </div>
                        <table id="table-setor" class="search-page">
                            <thead>
                                <tr>
                                    <th> ID </th>
                                    <th> SETOR </th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>

                    <div class="card-action right-align">
                        <a class="waves-effect waves-light btn disabled" name="editar" id="editarBtn" href="#modal-edit">Editar</a>
                    </div>
                </div>
                <!--action button-->
                <div class="fixed-action-btn horizontal">
                    <a class="btn-floating btn-large red">
                        <i class="large material-icons">add</i>
                    </a>
                    <ul>
                        <li><a href="javascripti:void(0)" onclick="javascript:goCreate(); return false;" class="btn-floating purple"><i class="material-icons">edit</i></a></li>
                        <li><a href="javascripti:void(0)" onclick="javascript:goHome(); return false;" id="home" class="btn-floating green"><i class="material-icons">home</i></a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Structure -->
    <div id="modal-edit" class="modal modal-fixed-footer">
        <div class="modal-content">
            <span class="card-title">Editar Setor</span>

            <form method="POST" name="setor-form" action="" id="setor-form">

                <div class="row">
                    <div class="input-field col s1">
                        <input disabled name="id" id="id" type="text">
                        <label for="disabled">ID</label>
                    </div>
                </div>
                <div class="row">
                    <div class="input-field col m12 s12">
                        <input id="nome" name="nome" type="text" class="validate" required="">
                        <label for="nome">Nome</label>
                    </div>
                </div>

            </form>
        </div>
        <div class="modal-footer">
            <div class="card-action right-align">

                <a href="#!" class="modal-action modal-close waves-effect waves-green btn-flat " id="delete">Deletar</a>
                <a href="#!" class="modal-action modal-close waves-effect waves-green btn-flat " id="update">Enviar</a>

            </div>
        </div>
    </div>

    <!--Import jQuery before materialize.js-->
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script type="text/javascript" src="/js/bin/materialize.min.js"></script>
    <!--Import DataTables-->
    <script type="text/javascript" src="/js/bin/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="/js/bin/general.js"></script>

    <script>
        var id_setor = "";
        function getSetor(id, tipo, s) {
                console.log(id, tipo, s);
                $.ajax({
                    type: tipo,
                    url: "http://192.168.10.10:3004/setor/" + id,
                    dataType: "json",
                    success: s

                });

            };
        $(document).ready(function() {

            

            

            //Populates Table with Json
            var table = $('table#table-setor').DataTable({
                ajax: {
                    url: "http://192.168.10.10:3004/setor",
                    contentType: 'application/json; charset=UTF-8',
                    dataType: 'json',
                    dataSrc: ''
                },
                columns: [{
                    data: "id"
                }, {
                    data: "nome"
                }],
                "columnDefs": [{
                    "width": "50%",
                    "targets": 0
                }, {
                    "width": "40%",
                    "targets": 1
                }],
                select: true,
                fixedColumns: true,
                lengthChange: false,
                pageLength: 5,
                dom: 'lrti<"right"p>',
                language: {
                    url: "../../doc/Portuguese-Brasil.json"
                }
            });

            //Call modal form
            $('.modal').modal({
                dismissible: false
            });

            // #serch-input is a <input type="text"> element
            $('#search-input').on('keyup', function() {
                table.search(this.value).draw();
            });

            //Load Navbar and dropdown menu
            $('#nav-bar').load("/modules/navbar.html", function() {
                $(".button-collapse").sideNav();
                $('.dropdown-button').dropdown();
            });

            //Enable edit button and set id
            $('.search-page tbody').on('click', 'tr', function() {
                if ($(this).hasClass('selected')) {
                    $(this).removeClass('selected');
                    $('#editarBtn').addClass('disabled');
                } else {
                    table.$('tr.selected').removeClass('selected');
                    $(this).addClass('selected');
                    $('#editarBtn').removeClass('disabled');
                    id_setor = table.row(this).data();

                }
            });



            $('#editarBtn').on('click', getSetor(id_setor, "GET",function(data, status) {
                console.log(id_setor);
                $("#id").val(data.id);
                $("#nome").val(data.nome);

                //Reload Material Form
                Materialize.updateTextFields();
            }));

            
            //Get id from json and populate the modal field
            //                        $('#editarBtn').on('click', function() {
            //                            $.get("http://192.168.10.10:3004/setor/" + update.id, function(data, status) {
            //                                $("#id").val(data.id);
            //                                $("#nome").val(data.nome);
            //            
            //                                //Reload Material Form
            //                                Materialize.updateTextFields();
            //            
            //                            });
            //                        });

            //Delete request
            $('#delete').on('click', function() {
                $.ajax({
                    type: "DELETE",
                    url: "http://192.168.10.10:3004/setor/" + update.id,
                    dataType: "json",

                    //if received a response from the server
                    success: function(response) {
                        //Reload dataTable
                        $('#table-setor').DataTable().ajax.reload();


                    },

                });
            });

            //Update setor
            $("#update").click(function(e) {

                //get de form data
                data = $("#nome").serializeArray();
                console.log(data);

                //make AJAX request
                //$("#form").validate();
                //if ($("#form").valid()) {
                $.ajax({
                    type: "PUT",
                    url: "http://192.168.10.10:3004/setor/" + update.id,
                    data: data,
                    dataType: "json",


                    //if received a response from the server
                    success: function(response) {

                        //Reload dataTable
                        $('#table-setor').DataTable().ajax.reload();
                        alert("FUNFA");
                    },

                });
                //}
                //Reload Material Form
                //Materialize.updateTextFields();
            }); //Update End


        });

    </script>

</body>

</html>
